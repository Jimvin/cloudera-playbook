---
# Cloudera playbook

- name: Stop account lockouts
  hosts: scm_server
  roles:
    - lockout_block
  tags:
    - always

- name: Apply pre-reqs fix
  hosts: all
  roles:
    - pre_reqs
  tags: [pre_reqs, pre_build]

- name: Configure Cloudera Manager Repository
  hosts: all
  roles:
    - cm_repo
  tags: [cm_repo, pre_build]

- name: Install rngd
  hosts: all
  roles:
    - rngd
  tags: [rngd, pre_build]

- name: Install Java
  hosts: all
  roles:
    - java
  tags: [java, pre_build]

- name: Install database server and create databases
  hosts: db_server
  roles:
    - { role: mariadb, when: database_type == 'mysql' }
  tags: mysql

- name: Install DB Connectors
  hosts: cdh_servers:cdsw_servers
  roles:
    - db_connector
    - mysql_connector
  tags: [db_connector, pre_build]

- name: Install MIT KDC Server
  hosts: krb5_server
  roles:
    - { role: krb5_server, when: krb5_kdc_type == 'mit' }
  tags: [krb5, pre_build]

- name: Install Cloudera Manager Agents
  hosts: all
  roles:
    - cm_agents
  tags: cm_agents

- name: Configure CA
  hosts: ca_server
  roles:
    - ca_server
  tags: [ca_server, pki]

- name: Setup certificates
  hosts: all
  roles:
    - certs
  tags: [certs, pki]

- name: Sign Certs
  hosts: ca_server
  roles:
    - ca_server_signing
  tags: [ca_server_signing, pki]

- name: Install certificates
  hosts: all
  roles:
    - certs_signed_install
  tags: [certs_signed_install, pki]

- name: Install Cloudera Manager Server
  hosts: scm_server
  roles:
    - scm
  tags: [cm_cluster_template, cm_install]

- name: Map Cloudera Manager Roles to LDAP groups
  hosts: scm_server
  roles:
    - { role: cm_roles, when: cluster_version_cdh_major >= '6' }
  tags: [cm_roles, cm_install]

- name: Install Cloudera Manager Agents - tls
  hosts: all
  roles:
    - cm_agents_tls
  tags: [cm_agents_tls, cm_install]

- name: Install CDH
  hosts: scm_server
  roles:
    - cdh
  tags:
  - cdh_cluster_install

- name: Install KTS
  hosts: scm_server
  roles:
    - { role: kts, when: hdfs_tde_enabled == 'True' }
  tags: [kts_cluster_template, kts]

- name: Sync KTS keys
  hosts: kts_servers
  roles:
    - { role: kts_key_sync, when: hdfs_tde_enabled == 'True' }
  tags: [kts_key_sync, kts]

- name: Sync KMS keys
  hosts: kms_servers
  roles:
    - { role: kms_key_sync, when: hdfs_tde_enabled == 'True' }
  tags: [kms_key_sync, kms]

- name: Create Encryption Zones
  hosts: master_servers
  roles:
    - { role: kms_encryption_zones, when: hdfs_tde_enabled == 'True' }
  tags: [enc_zones, kms]

- name: Install and Configure HAProxy
  hosts: haproxy
  roles:
    - haproxy
  tags: haproxy

- name: Postinstall Tasks
  hosts: all
  roles:
    - postinstall
  tags: postinstall
